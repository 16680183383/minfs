<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>minFS 可视化控制台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;--bg-2:#0f1830;--card:#111a2b;--line:#1e2a44;--txt:#e6eefc;--sub:#9bb6e7;--brand:#6c8cff;--ok:#3ad29f;--err:#ff6b6b;
      --grad:linear-gradient(135deg, #6c8cff 0%, #8b5cf6 50%, #00d4ff 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,Segoe UI,Arial; margin:0; background:radial-gradient(1200px 800px at 80% -20%, #152042 0%, rgba(21,32,66,0) 60%), var(--bg); color:var(--txt)}
    header{padding:16px 20px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(15,24,48,.9), rgba(15,24,48,.6)); backdrop-filter:saturate(150%) blur(8px); border-bottom:1px solid var(--line)}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:34px; height:34px; border-radius:10px; background:var(--grad); box-shadow:0 6px 30px rgba(108,140,255,.5)}
    h1{margin:0; font-size:18px; font-weight:800; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--sub)}
    nav{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
    .tab{padding:8px 12px; border:1px solid var(--line); border-radius:999px; color:var(--sub); cursor:pointer; user-select:none}
    .tab.active{color:var(--txt); border-color:transparent; background:rgba(108,140,255,.12)}
    main{padding:20px; display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
    .card{background:linear-gradient(180deg, rgba(17,26,43,.9), rgba(17,26,43,.7)); border:1px solid var(--line); border-radius:14px; padding:16px; position:relative; overflow:hidden}
    .card h2{margin:0 0 12px 0; font-size:16px}
    .glow{position:absolute; inset:-2px; pointer-events:none; border-radius:14px; background:conic-gradient(from 0deg, rgba(108,140,255,.15), rgba(0,212,255,.08), rgba(139,92,246,.12), rgba(108,140,255,.15)); filter:blur(18px); opacity:.35}
    input, textarea, button, select{background:#0c1527; border:1px solid #223457; color:var(--txt); border-radius:10px; padding:10px 12px}
    input, textarea, select{width:100%}
    button{cursor:pointer; transition:.2s ease; background:linear-gradient(180deg, #0c1527, #0a1330)}
    button:hover{transform:translateY(-1px); box-shadow:0 6px 20px rgba(108,140,255,.18); border-color:#2e4890}
    .btn-brand{background:var(--grad); color:white; border:0}
    .btn-danger{background:linear-gradient(180deg, #2a0e12, #19090c); border-color:#5b1f28; color:#ffd2d2}
    .row{display:flex; gap:10px; margin:10px 0}
    pre{background:#0c1527; border:1px solid #223457; border-radius:10px; padding:10px; display:block; white-space:pre-wrap; max-height:280px; overflow:auto}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .kpi{display:flex; flex-direction:column; gap:6px; padding:10px; border-radius:12px; border:1px dashed #2a3b64}
    .kpi .v{font-size:20px; font-weight:800}
    .kpi .t{font-size:12px; color:var(--sub)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#0f1a33}
    .dot{width:8px; height:8px; border-radius:99px; background:#3ad29f}
    .status-err{background:#ff6b6b}
    footer{padding:12px 20px; border-top:1px solid var(--line); color:#8aa4d4}
    .toast{position:fixed; right:16px; bottom:16px; min-width:220px; background:#0c1527; border:1px solid #244173; color:var(--txt); padding:10px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); opacity:0; transform:translateY(10px); transition:.2s}
    .toast.show{opacity:1; transform:translateY(0)}
    .section{display:none}
    .section.active{display:block}
    .divider{height:1px; background:linear-gradient(90deg, transparent, #243a6b 40%, #243a6b 60%, transparent); margin:6px 0}
    table{width:100%; border-collapse:collapse; background:#0c1527; border:1px solid #223457; border-radius:10px; overflow:hidden}
    th,td{padding:8px 10px; border-bottom:1px solid #223457; color:var(--txt); font-size:12px}
    th{background:#0f1a33; text-align:left; color:#9bb6e7}
    /* 文件系统选择器样式 */
    .filesystem-selector{margin-top:12px; padding:12px; background:rgba(17,26,43,.6); border:1px solid var(--line); border-radius:10px}
    .fs-controls{display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap}
    .fs-input{flex:1; min-width:150px; max-width:200px}
    .fs-info{display:flex; align-items:center; gap:8px; font-size:12px}
    .fs-label{color:var(--sub)}
    .fs-current{color:var(--brand); font-weight:600; padding:2px 8px; background:rgba(108,140,255,.1); border-radius:6px}
    .fs-status{color:var(--ok); font-size:11px}
    .fs-status.error{color:var(--err)}
    /* 用例面板样式 */
    .case-steps{display:none; padding:6px 0}
    .case-steps.active{display:block}
    .step{padding:8px 10px; border:1px dashed #2a3b64; border-radius:8px; margin:6px 0; cursor:pointer}
    .step:hover{background:#0f1a33}
    .focus-ring{outline:2px solid #6c8cff; outline-offset:2px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    // 文件系统管理
    let currentFileSystem = 'demo';
    
    function switchFileSystem() {
      const fsName = $('fsName').value.trim();
      if (!fsName) {
        showToast('请输入文件系统名称', false);
        return;
      }
      currentFileSystem = fsName;
      $('currentFs').textContent = fsName;
      $('fsStatus').textContent = '✓ 已切换';
      $('fsStatus').className = 'fs-status';
      showToast(`已切换到文件系统: ${fsName}`);
      
      // 清空所有输出区域
      clearAllOutputs();
    }
    
    function createFileSystem() {
      const fsName = $('fsName').value.trim();
      if (!fsName) {
        showToast('请输入文件系统名称', false);
        return;
      }
      currentFileSystem = fsName;
      $('currentFs').textContent = fsName;
      $('fsStatus').textContent = '✓ 新创建';
      $('fsStatus').className = 'fs-status';
      showToast(`已创建并切换到文件系统: ${fsName}`);
      
      // 清空所有输出区域
      clearAllOutputs();
    }
    
    async function listFileSystems() {
      const el = $('fsListOut');
      const r = await api('/api/fs/filesystems');
      setJson('fsListOut', r);
      el.style.display = 'block';
      showToast('已获取文件系统列表');
    }

    function hideFileSystems(){
      const el = $('fsListOut');
      el.textContent = '';
      el.style.display = 'none';
      showToast('已关闭文件系统显示');
    }
    
    function clearAllOutputs() {
      // 清空所有输出区域
      const outputs = ['dirOut', 'createOut', 'statOut', 'listOut', 'delOut', 'writeOut', 'readOut', 'wrOut', 'batchOut', 'clusterOut', 'fsckOut', 'fsStatsOut', 'globalStatsOut'];
      outputs.forEach(id => {
        const el = $(id);
        if (el) el.textContent = '';
      });
    }
    
    function showToast(msg, ok=true){
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><span class="dot ${ok?'':'status-err'}"></span><div>${msg}</div></div>`;
      document.body.appendChild(t);
      requestAnimationFrame(()=>t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 2500);
    }
    async function api(path, opts){
      try{
        const res = await fetch(path, opts);
        const txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return txt; }
      }catch(e){ showToast('请求失败: '+e.message, false); return {error:e.message}; }
    }
    function setJson(id, v){ $(id).textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2); }
         function switchTab(name){
       [...document.querySelectorAll('.tab')].forEach(x=>x.classList.remove('active'));
       [...document.querySelectorAll('.section')].forEach(x=>x.classList.remove('active'));
       $(`tab-${name}`).classList.add('active');
       $(`sec-${name}`).classList.add('active');
       // 右侧用例面板常驻
       const cases = $('sec-cases'); if (cases) cases.classList.add('active');
       
       // 当切换到集群可视化标签页时，自动加载集群信息
       if (name === 'cluster') {
         loadCluster();
       }
     }
    function formatBytes(b){
      if (b == null || isNaN(b)) return '-';
      const u = ['B','KB','MB','GB','TB']; let i=0; let v = Number(b);
      while (v >= 1024 && i < u.length-1){ v/=1024; i++; }
      return (i===0? v.toString(): v.toFixed(2)) + ' ' + u[i];
    }
    // 基础操作
    async function mkdir(){
      const p = $('dirPath').value.trim(); setJson('dirOut','');
      const r = await api(`/api/fs/mkdir?path=${encodeURIComponent(p)}`, {
        method:'POST',
        headers: {'fileSystemName': currentFileSystem}
      });
      setJson('dirOut', r); showToast(r.success?`目录创建成功: ${p}`:`目录创建失败` , !!r.success);
    }
    async function create(){
      const p = $('filePath').value.trim(); setJson('createOut','');
      const r = await api(`/api/fs/create?path=${encodeURIComponent(p)}`, {
        method:'POST',
        headers: {'fileSystemName': currentFileSystem}
      });
      setJson('createOut', r); showToast(r.success?`文件创建成功: ${p}`:`文件创建失败` , !!r.success);
    }
    async function stat(){
      const p = $('statPath').value.trim(); setJson('statOut','');
      const r = await api(`/api/fs/stat?path=${encodeURIComponent(p)}`, {
        headers: {'fileSystemName': currentFileSystem}
      });
      setJson('statOut', r);
    }
    async function list(){
      const p = $('listPath').value.trim(); setJson('listOut','');
      const r = await api(`/api/fs/list?path=${encodeURIComponent(p)}`, {
        headers: {'fileSystemName': currentFileSystem}
      });
      setJson('listOut', r);
    }
    async function del(){
      const p = $('delPath').value.trim(); setJson('delOut','');
      const r = await api(`/api/fs/delete?path=${encodeURIComponent(p)}`, {
        method:'DELETE',
        headers: {'fileSystemName': currentFileSystem}
      });
      setJson('delOut', r); showToast(r.success?`已删除: ${p}`:`删除失败`, !!r.success);
    }
    async function writeText(){
      const p = $('writePath').value.trim(); const c = $('writeContent').value; setJson('writeOut','');
      const r = await api(`/api/fs/write?path=${encodeURIComponent(p)}`, {
        method:'POST', 
        headers:{
          'Content-Type':'text/plain;charset=UTF-8',
          'fileSystemName': currentFileSystem
        }, 
        body:c
      });
      setJson('writeOut', r); showToast(r.success?`写入成功: ${r.size}B`:`写入失败`, !!r.success);
    }
    async function read(){
      const p = $('readPath').value.trim(); 
      const t = await api(`/api/fs/read?path=${encodeURIComponent(p)}`, {
        headers: {'fileSystemName': currentFileSystem}
      }); 
      setJson('readOut', t);
    }
    // 集群信息 + 可视化
    let chartCombined;
    function ensureCharts(){
      if (window.echarts && !chartCombined){
        const el = $('chart-combined');
        if (el) chartCombined = echarts.init(el);
      }
    }
    function renderClusterCharts(info){
      ensureCharts();
      if (!window.echarts){ setJson('clusterOut', info); return; }
      if (!chartCombined){
        const el = $('chart-combined');
        if (el && window.echarts) chartCombined = echarts.init(el);
      }
      const ds = info?.dataServer || [];
      const rep = info?.replicaDistribution || {};
      const prim = rep.primaryReplicaCount||{}; const tot = rep.totalReplicaCount||{};
      const names = (ds.length? ds.map(d=>`${d.host||'host'}:${d.port}`) : Object.keys({...tot, ...prim}));
      const usedGB = names.map(n=>{
        const d = ds.find(x=>`${x.host}:${x.port}`===n) || {}; return (d.useCapacity||0)/(1024*1024*1024);
      });
      const totalGB = names.map(n=>{
        const d = ds.find(x=>`${x.host}:${x.port}`===n) || {}; return (d.capacity||0)/(1024*1024*1024);
      });
      const primArr = names.map(n=>prim[n]||0);
      const totArr = names.map(n=>tot[n]||0);
      chartCombined.setOption({
        darkMode:true,
        backgroundColor:'transparent',
        grid:{left:70,right:60,top:56,bottom:40, containLabel:true},
        tooltip:{trigger:'axis'},
        legend:{data:['Used(GB)','Total(GB)','Primary','Replicas'], textStyle:{color:'#c8d8ff'}},
        xAxis:{type:'category', data:names, axisLabel:{color:'#9bb6e7', rotate:20}},
        yAxis:[
          {type:'value', name:'GB', axisLabel:{color:'#9bb6e7'}},
          {type:'value', name:'副本数', axisLabel:{color:'#9bb6e7'}}
        ],
        series:[
          {name:'Used(GB)', type:'bar', data:usedGB, itemStyle:{color:'#6c8cff'}, yAxisIndex:0},
          {name:'Total(GB)', type:'bar', data:totalGB, itemStyle:{color:'#00d4ff'}, yAxisIndex:0},
          {name:'Primary', type:'line', data:primArr, itemStyle:{color:'#8b5cf6'}, yAxisIndex:1, smooth:true},
          {name:'Replicas', type:'line', data:totArr, itemStyle:{color:'#3ad29f'}, yAxisIndex:1, smooth:true}
        ]
      });
      // 确保首次渲染尺寸准确
      requestAnimationFrame(()=>{ if (chartCombined) chartCombined.resize(); });
      // 文本列表模块已移除，不再写入
      $('leaderAddr').textContent = info?.masterMetaServer ? (info.masterMetaServer.host+":"+info.masterMetaServer.port) : 'unknown';
      $('dsCount').textContent = (info?.dataServer?.length||0).toString();
      // followers
      const followers = (info?.slaveMetaServers || info?.slaveMetaServer || []).map(x=>`${x.host}:${x.port}`);
      const followerEl = $('followerList'); if (followerEl) followerEl.textContent = followers.length? followers.join(', ') : '-';
      // 总文件/目录
      const tf = info?.replicaDistribution?.totalFiles; const td = info?.replicaDistribution?.totalDirectories;
      const tfEl = $('totalFiles'); const tdEl = $('totalDirs'); if (tfEl) tfEl.textContent = (tf ?? '-'); if (tdEl) tdEl.textContent = (td ?? '-');
      // 健康
      const overall = info?.healthStatus?.overallHealth || '-'; const oh = $('overallHealth'); if (oh) oh.textContent = overall;
      const ok = (info?.healthStatus?.dataServerHealthy && info?.healthStatus?.metaServerHealthy);
      const dot = $('healthDot'); if (dot) { dot.classList.toggle('status-err', !ok); }
      setJson('clusterOut', info);
      // DataServer 详情表
      const tbody = $('dsTableBody');
      if (tbody){
        const ds = info?.dataServer || [];
        tbody.innerHTML = ds.map(d=>{
          const node = `${d.host}:${d.port}`;
          const files = d.fileTotal ?? 0;
          const usedB = d.useCapacity ?? 0;
          const capB = d.capacity ?? 0;
          return `<tr><td>${node}</td><td>${files}</td><td>${formatBytes(usedB)}</td><td>${formatBytes(capB)}</td></tr>`;
        }).join('');
      }
    }
    async function loadCluster(){
      const r = await api('/api/fs/cluster', {
        headers: {'fileSystemName': currentFileSystem}
      });
      renderClusterCharts(r);
    }
    
    // 获取文件系统统计信息
    async function getFileSystemStats() {
      try {
        setJson('fsStatsOut', '正在获取文件系统统计信息...');
        const stats = await api('/api/fs/fs/stats', { headers: { 'fileSystemName': currentFileSystem }});
        $('fsStatsName').textContent = stats.fileSystemName || currentFileSystem;
        $('fsStatsFiles').textContent = (stats.totalRegularFiles ?? stats.totalFiles ?? 0);
        $('fsStatsDirs').textContent = (stats.totalDirectories ?? 0);
        $('fsStatsSize').textContent = formatBytes(stats.totalSize ?? 0);
        setJson('fsStatsOut', stats);
        showToast(`已获取文件系统 ${currentFileSystem} 的统计信息`);
      } catch (error) {
        setJson('fsStatsOut', `获取文件系统统计失败: ${error.message}`);
        showToast('获取文件系统统计失败', false);
      }
    }
    
    // 获取全局统计信息
    async function getGlobalStats() {
      try {
        setJson('globalStatsOut', '正在获取全局统计信息...');
        const stats = await api('/api/fs/fs/global-stats');
        $('globalFsCount').textContent = (stats.totalFileSystems ?? '-');
        $('globalTotalFiles').textContent = (stats.totalRegularFiles ?? stats.totalFiles ?? 0);
        $('globalTotalDirs').textContent = (stats.totalDirectories ?? 0);
        setJson('globalStatsOut', stats);
        showToast('已获取全局统计信息');
      } catch (error) {
        setJson('globalStatsOut', `获取全局统计失败: ${error.message}`);
        showToast('获取全局统计失败', false);
      }
    }
         // 移除自动刷新功能，只在用户主动操作时加载集群信息
    // 写读一致性
    async function testWriteRead(sz){
      const sizeLabel = sz===(100*1024*1024)?'100M':(sz===(10*1024*1024)?'10M':'512K');
      
      // 添加大小检查，避免过大文件导致系统崩溃
      if (sz > 50 * 1024 * 1024) { // 50MB
        setJson('wrOut', `警告：${sizeLabel} 文件较大，可能导致系统不稳定。\n建议使用较小的文件进行测试。\n\n如果系统崩溃，请重启服务后重试。`);
        showToast(`文件过大，建议使用较小文件`, false);
        return;
      }
      
      const p = `/test_md5/bigfile_${sizeLabel}`;
      
      try {
        setJson('wrOut', `开始执行 ${sizeLabel} 文件测试...`);
        
        const r = await api(`/api/fs/testWriteRead?path=${encodeURIComponent(p)}&sizeBytes=${sz}`, {method:'POST'});
        
        if (r.error) {
          setJson('wrOut', `${sizeLabel} 执行失败: ${r.error}\n\n注意：大文件操作可能需要较长时间，请耐心等待。`);
          showToast(`${sizeLabel} 执行失败`, false);
          return;
        }
        
        const writeMd5 = r?.writeMd5 || r?.md5Write || r?.write_md5 || r?.write || '';
        const readMd5  = r?.readMd5  || r?.md5Read  || r?.read_md5  || r?.read  || '';
        
        let line;
        if (writeMd5 && readMd5){
          line = `${sizeLabel} 写入文件${p} MD5=${writeMd5}, 读取MD5=${readMd5}, 一致=${String(writeMd5===readMd5)}`;
        } else if (r && typeof r.equal !== 'undefined'){
          line = r.equal ? `${sizeLabel} 写入/读取MD5一致` : `MD5校验失败：写入与读取内容不一致`;
        } else {
          line = `${sizeLabel} 执行完成（文件大小: ${r.sizeBytes || sz} 字节）`;
        }
        
        // 添加处理方式说明
        if (r.note) {
          line += `\n\n处理方式: ${r.note}`;
        }
        
        setJson('wrOut', `${line}\n${JSON.stringify(r, null, 2)}`);
        showToast(`${sizeLabel} 执行完成`, true);
        
      } catch (error) {
        setJson('wrOut', `${sizeLabel} 执行异常: ${error.message}\n\n可能原因：\n1. 服务器内存不足\n2. 网络超时\n3. 文件过大\n\n建议：\n- 检查服务器内存使用情况\n- 尝试较小的文件大小\n- 重启服务后重试`);
        showToast(`${sizeLabel} 执行异常`, false);
      }
    }
    async function triggerFsck(){
      const r = await api('/api/fs/fsck', {
        method:'POST',
        headers: {'fileSystemName': currentFileSystem}
      });
      setJson('fsckOut', r); showToast(r.success?`已触发FSCK`:`触发FSCK失败`, !!r.success);
    }
    
    // 批量写读功能
    async function batchWriteRead(){
      setJson('batchOut', `开始执行批量写入测试...`);
      
      try {
        // 批量写入
        const writeResults = [];
        const startTime = Date.now();
        
        for (let i = 1; i <= 10; i++) {
          const fileName = `/test_performance/file${i}.txt`;
          const content = `这是第${i}个批量创建的测试文件，内容长度适中。`;
          
          try {
            const writeResult = await api(`/api/fs/write?path=${encodeURIComponent(fileName)}`, {
              method: 'POST', 
              headers: {
                'Content-Type': 'text/plain;charset=UTF-8',
                'fileSystemName': currentFileSystem
              }, 
              body: content
            });
            
            if (writeResult.success) {
              writeResults.push(`✓ 文件 ${fileName} 创建成功`);
            } else {
              writeResults.push(`✗ 文件 ${fileName} 创建失败: ${writeResult.message || '未知错误'}`);
            }
          } catch (error) {
            writeResults.push(`✗ 文件 ${fileName} 创建异常: ${error.message}`);
          }
        }
        
        const writeTime = Date.now() - startTime;
        
        // 汇总结果
        const successCount = writeResults.filter(r => r.includes('✓')).length;
        
        const summary = [
          `=== 批量写入测试完成 ===`,
          `写入耗时: ${writeTime}ms`,
          `写入成功: ${successCount}/10 个文件`,
          '',
          '=== 写入结果 ===',
          ...writeResults,
          '',
          '=== 操作说明 ===',
          '文件已创建在 /test_performance/ 目录下',
          '如需删除文件，请使用下方删除按钮'
        ].join('\n');
        
        setJson('batchOut', summary);
        showToast(`批量写入完成: ${successCount}/10 个文件创建成功`, successCount === 10);
        
      } catch (error) {
        setJson('batchOut', `批量写入测试失败: ${error.message}`);
        showToast('批量写入测试失败', false);
      }
    }
    
    // 批量删除功能
    async function batchDelete(){
      setJson('batchOut', `开始执行批量删除测试...`);
      
      try {
        const deleteResults = [];
        const startTime = Date.now();
        
        for (let i = 1; i <= 10; i++) {
          const fileName = `/test_performance/file${i}.txt`;
          
          try {
            const deleteResult = await api(`/api/fs/delete?path=${encodeURIComponent(fileName)}`, {
              method: 'DELETE',
              headers: {'fileSystemName': currentFileSystem}
            });
            
            if (deleteResult.success) {
              deleteResults.push(`✓ 文件 ${fileName} 删除成功`);
            } else {
              deleteResults.push(`✗ 文件 ${fileName} 删除失败: ${deleteResult.message || '未知错误'}`);
            }
          } catch (error) {
            deleteResults.push(`✗ 文件 ${fileName} 删除异常: ${error.message}`);
          }
        }
        
        const deleteTime = Date.now() - startTime;
        const successCount = deleteResults.filter(r => r.includes('✓')).length;
        
        const summary = [
          `=== 批量删除测试完成 ===`,
          `删除耗时: ${deleteTime}ms`,
          `删除成功: ${successCount}/10 个文件`,
          '',
          '=== 删除结果 ===',
          ...deleteResults
        ].join('\n');
        
        setJson('batchOut', summary);
        showToast(`批量删除完成: ${successCount}/10 个文件删除成功`, successCount === 10);
        
      } catch (error) {
        setJson('batchOut', `批量删除测试失败: ${error.message}`);
        showToast('批量删除测试失败', false);
      }
    }
    // ===== 测试用例面板 =====
    const caseDefs = {
      1: { title:'用例1 基础目录操作', steps:[
        {label:'1.1 创建目录 /test_basic', action:{tab:'ops', fills:{dirPath:'/test_basic'}}},
        {label:'1.2 创建多级目录 /test_basic/sub1/sub2', action:{tab:'ops', fills:{dirPath:'/test_basic/sub1/sub2'}}},
        {label:'1.3 检查目录是否存在', action:{tab:'ops', fills:{statPath:'/test_basic'}}},
        {label:'1.4 列出目录内容', action:{tab:'ops', fills:{listPath:'/test_basic'}}},
        {label:'1.5 清理测试目录', action:{tab:'ops', fills:{delPath:'/test_basic'}}}
      ]},
      2: { title:'用例2 基础文件操作', steps:[
        {label:'2.1 创建测试目录', action:{tab:'ops', fills:{dirPath:'/test_file_ops'}}},
        {label:'2.2 创建/写入 /test_file_ops/hello.txt（文本面板）', action:{tab:'consistency', fills:{writePath:'/test_file_ops/hello.txt', writeContent:'Hello, easyClient SDK! 这是一个测试文件。\n包含中文内容：你好世界！'}}},
        {label:'2.3/2.4 获取文件状态', action:{tab:'ops', fills:{statPath:'/test_file_ops/hello.txt'}}},
        {label:'2.5 读取文件内容', action:{tab:'consistency', fills:{readPath:'/test_file_ops/hello.txt'}}},
        {label:'2.6 删除文件', action:{tab:'ops', fills:{delPath:'/test_file_ops/hello.txt'}}},
        {label:'2.x 删除目录', action:{tab:'ops', fills:{delPath:'/test_file_ops'}}}
      ]},
      3: { title:'用例3 文件写入与读取（大文件）', steps:[
        {label:'3.1 创建目录 /test_md5', action:{tab:'ops', fills:{dirPath:'/test_md5'}}},
        {label:'3.2 准备写 100MB/10MB/512KB（使用下方按钮执行）', action:{tab:'consistency'}},
        {label:'3.3 读取并校验MD5（查看写读一致性区域）', action:{tab:'consistency'}}
      ]},
      4: { title:'用例4 性能测试（批量写读）', steps:[
          {label:'4.1 创建目录 /test_performance', action:{tab:'ops', fills:{dirPath:'/test_performance'}}},
          {label:'4.2 执行批量写入（10个文件）', action:{tab:'consistency'}},
          {label:'4.3 执行批量删除（10个文件）', action:{tab:'consistency'}}
        ]},
      5: { title:'用例5 高可用演示（指南）', steps:[
        {label:'5.1 创建/写入 /test_ha/before_ha.txt（文本面板）', action:{tab:'consistency', fills:{writePath:'/test_ha/before_ha.txt', writeContent:'Before HA failover - 基线写入'}}},
        {label:'5.2 切换到集群可视化观察 & 手动停止部分节点', action:{tab:'cluster'}},
        {label:'5.3 故障后写入 /test_ha/after_ha.txt（文本面板）', action:{tab:'consistency', fills:{writePath:'/test_ha/after_ha.txt', writeContent:'After HA failover - 故障后写入'}}}
      ]},
      6: { title:'用例6 FSCK副本自愈与清理', steps:[
        {label:'6.1 创建目录 /test_fsck', action:{tab:'ops', fills:{dirPath:'/test_fsck'}}},
        {label:'6.2 创建并写入 /test_fsck/fsck.txt', action:{tab:'consistency', fills:{writePath:'/test_fsck/fsck.txt', writeContent:'FSCK HEAL & CLEAN TEST'}}},
        {label:'6.3 获取文件状态 /test_fsck/fsck.txt', action:{tab:'ops', fills:{statPath:'/test_fsck/fsck.txt'}}},
        {label:'6.4 手动停止一个DataServer（观察）', action:{tab:'cluster'}},
        {label:'6.5 触发FSCK自愈（请点工具与维护）', action:{tab:'tools'}},
        {label:'6.6 再次触发FSCK清理历史脏副本', action:{tab:'tools'}},
        {label:'6.x 可选：删除目录 /test_fsck', action:{tab:'ops', fills:{delPath:'/test_fsck'}}}
      ]}
    };
    function highlight(el){ if(!el) return; el.classList.add('focus-ring'); setTimeout(()=>el.classList.remove('focus-ring'), 900); el.scrollIntoView({behavior:'smooth', block:'center'}); }
    function applyAction(a){ if(!a) return; if(a.tab) switchTab(a.tab); setTimeout(()=>{ if(a.fills){ Object.entries(a.fills).forEach(([id,v])=>{ const el=$(id); if(el){ el.value=v; highlight(el); }}); } }, 10); }
    function renderCases(){
      const root = $('casesRoot'); if(!root) return; root.innerHTML = Object.entries(caseDefs).map(([k,c])=>{
        const sid = `case-${k}`; return `<div class="card" style="margin:0"><h2 style="cursor:pointer" onclick="document.getElementById('${sid}').classList.toggle('active')">${c.title}</h2><div id="${sid}" class="case-steps">${c.steps.map((s,i)=>`<div class="step" onclick='applyAction(${JSON.stringify(s.action)})'>${s.label}</div>`).join('')}</div></div>`;
      }).join('');
    }
         // 初始化
     window.addEventListener('DOMContentLoaded', ()=>{
       switchTab('ops');
       // 移除自动加载集群信息，只在用户主动操作时加载
       window.addEventListener('resize', ()=>{ if(chartCombined) chartCombined.resize(); });
       renderCases();
     });
  </script>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>minFS 可视化控制台</h1>
        <div class="sub">基于 easyClient SDK · 通过 ZK 自动发现 MetaServer Leader</div>
      </div>
    </div>
    <nav>
      <div id="tab-ops" class="tab active" onclick="switchTab('ops')">基础操作</div>
      <div id="tab-consistency" class="tab" onclick="switchTab('consistency')">写读一致性</div>
      <div id="tab-cluster" class="tab" onclick="switchTab('cluster')">集群可视化</div>
      <div id="tab-tools" class="tab" onclick="switchTab('tools')">工具与维护</div>
    </nav>
    <div class="filesystem-selector">
      <div class="fs-controls">
        <input id="fsName" type="text" placeholder="文件系统名称" value="demo" class="fs-input">
        <button onclick="switchFileSystem()" class="btn-brand">切换文件系统</button>
        <button onclick="createFileSystem()" class="btn-brand">创建新文件系统</button>
        <button onclick="listFileSystems()" class="btn-brand">列出所有文件系统</button>
        <button onclick="hideFileSystems()" class="btn-danger">关闭文件系统显示</button>
      </div>
      <div class="fs-info">
        <span class="fs-label">当前文件系统: </span>
        <span id="currentFs" class="fs-current">demo</span>
        <span class="fs-status" id="fsStatus">✓ 已连接</span>
      </div>
      <pre id="fsListOut" style="margin-top:8px; display:none"></pre>
    </div>
  </header>
  <main>
    <section id="sec-ops" class="section active">
      <div class="card">
        <div class="glow"></div>
        <h2>1. 创建目录</h2>
        <div class="row"><input id="dirPath" placeholder="例如 /demo/dir"/><button class="btn-brand" onclick="mkdir()">创建</button></div>
        <pre id="dirOut"></pre>
      </div>

      <div class="card">
        <div class="glow"></div>
        <h2>2. 创建文件</h2>
        <div class="row"><input id="filePath" placeholder="例如 /demo/dir/hello.txt"/><button class="btn-brand" onclick="create()">创建</button></div>
        <pre id="createOut"></pre>
      </div>

      <div class="card">
        <div class="glow"></div>
        <h2>3. 查看属性（stat）</h2>
        <div class="row"><input id="statPath" placeholder="文件或目录路径"/><button onclick="stat()">查询</button></div>
        <pre id="statOut"></pre>
      </div>

      <div class="card">
        <div class="glow"></div>
        <h2>4. 列表（listStatus）</h2>
        <div class="row"><input id="listPath" placeholder="目录路径"/><button onclick="list()">列出</button></div>
        <pre id="listOut"></pre>
      </div>

      <div class="card">
        <div class="glow"></div>
        <h2>5. 删除（支持递归）</h2>
        <div class="row"><input id="delPath" placeholder="文件或目录路径"/><button class="btn-danger" onclick="del()">删除</button></div>
        <pre id="delOut"></pre>
      </div>
    </section>

    <section id="sec-consistency" class="section">
      <div class="card" style="margin-bottom:16px">
        <div class="glow"></div>
        <h2>6. 写入/读取（文本）</h2>
        <div class="row"><input id="writePath" placeholder="文件路径"/><button class="btn-brand" onclick="writeText()">写入</button></div>
        <div class="row"><textarea id="writeContent" rows="5" placeholder="要写入的内容"></textarea></div>
        <pre id="writeOut"></pre>
        <div class="divider"></div>
        <div class="row"><input id="readPath" placeholder="文件路径"/><button onclick="read()">读取</button></div>
        <pre id="readOut"></pre>
      </div>

             <div class="card">
         <div class="glow"></div>
         <h2>7. 写入/读取一致性（MD5校验）</h2>
         <div class="row">
           <button onclick="testWriteRead(512*1024)">写读 512KB</button>
           <button onclick="testWriteRead(10*1024*1024)">写读 10MB</button>
           <button onclick="testWriteRead(100*1024*1024)">写读 100MB</button>
         </div>
         <pre id="wrOut" style="margin-top:12px"></pre>
       </div>

               <div class="card">
          <div class="glow"></div>
          <h2>8. 批量写读（性能测试）</h2>
          <div class="row">
            <button onclick="batchWriteRead()" class="btn-brand">批量写入</button>
            <button onclick="batchDelete()" class="btn-danger">批量删除</button>
          </div>
          <pre id="batchOut" style="margin-top:12px"></pre>
        </div>
    </section>

    <section id="sec-cluster" class="section">
      <div class="card">
        <div class="glow"></div>
        <h2>8. 集群可视化</h2>
        <div class="grid-3">
          <div class="kpi"><div class="t">最近 Leader</div><div id="leaderAddr" class="v">-</div></div>
          <div class="kpi"><div class="t">DataServer 数量</div><div id="dsCount" class="v">-</div></div>
          <div class="kpi"><div class="t">自动刷新</div><div class="v"><span class="pill"><span class="dot"></span>5s</span></div></div>
        </div>
        <div class="grid-3" style="margin-top:10px">
          <div class="kpi"><div class="t">Followers</div><div id="followerList" class="v" style="font-size:14px">-</div></div>
          <div class="kpi"><div class="t">总文件数</div><div id="totalFiles" class="v">-</div></div>
          <div class="kpi"><div class="t">总目录数</div><div id="totalDirs" class="v">-</div></div>
        </div>
        <div class="kpi" style="margin-top:10px; display:inline-flex;align-items:center;gap:8px"><span id="healthDot" class="dot"></span><span>整体健康：</span><span id="overallHealth">-</span></div>
        <div style="min-height:280px; margin:28px 0">
          <div id="chart-combined" style="height:280px"></div>
        </div>
        <div class="divider"></div>
        <div class="card" style="margin:6px 0">
          <h2 style="margin:0 0 8px 0; font-size:14px">DataServer 详情</h2>
          <table>
            <thead>
              <tr><th>节点</th><th>文件数</th><th>已用</th><th>总容量</th></tr>
            </thead>
            <tbody id="dsTableBody"></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:4px"><button onclick="loadCluster()">立即刷新</button></div>
        <pre id="clusterOut"></pre>
      </div>
    </section>

    <section id="sec-tools" class="section">
      <div class="card">
        <div class="glow"></div>
        <h2>9. 工具与维护</h2>
        <div class="row">
          <button class="btn-brand" onclick="triggerFsck()">触发 FSCK 自检/修复</button>
          <button class="btn-brand" onclick="getFileSystemStats()">获取文件系统统计</button>
          <button class="btn-brand" onclick="getGlobalStats()">获取全局统计</button>
        </div>
        <pre id="fsckOut"></pre>
      </div>
      
      <div class="card">
        <div class="glow"></div>
        <h2>10. 文件系统统计信息</h2>
        <div class="grid-2">
          <div class="kpi">
            <div class="t">当前文件系统</div>
            <div id="fsStatsName" class="v">-</div>
          </div>
          <div class="kpi">
            <div class="t">文件数量</div>
            <div id="fsStatsFiles" class="v">-</div>
          </div>
        </div>
        <div class="grid-2" style="margin-top:10px">
          <div class="kpi">
            <div class="t">目录数量</div>
            <div id="fsStatsDirs" class="v">-</div>
          </div>
          <div class="kpi">
            <div class="t">总大小</div>
            <div id="fsStatsSize" class="v">-</div>
          </div>
        </div>
        <pre id="fsStatsOut"></pre>
      </div>
      
      <div class="card">
        <div class="glow"></div>
        <h2>11. 全局统计信息</h2>
        <div class="grid-3">
          <div class="kpi">
            <div class="t">总文件系统数</div>
            <div id="globalFsCount" class="v">-</div>
          </div>
          <div class="kpi">
            <div class="t">总文件数</div>
            <div id="globalTotalFiles" class="v">-</div>
          </div>
          <div class="kpi">
            <div class="t">总目录数</div>
            <div id="globalTotalDirs" class="v">-</div>
          </div>
        </div>
        <pre id="globalStatsOut"></pre>
      </div>
    </section>

    <section id="sec-cases" class="section active">
      <div class="card">
        <div class="glow"></div>
        <h2>12. 测试用例面板（点击展开步骤）</h2>
        <div id="casesRoot"></div>
      </div>
    </section>
  </main>
  <footer>
    端口 9090 · 所有操作均调用 easyClient SDK · UI 本地单页，无需额外依赖
  </footer>
</body>
</html>


